var Monitor=function(){"use strict";var t,e,s,n;!function(t){t.XHR="xhr",t.FETCH="fetch",t.CONSOLE="console",t.DOM="dom",t.HISTORY="history",t.ERROR="error",t.HASHCHANGE="hashchange",t.UNHANDLEDREJECTION="unhandledrejection",t.VUE="Vue"}(t||(t={})),function(t){t[t.CRITICAL=1]="CRITICAL",t[t.HIGH=2]="HIGH",t[t.NORMAL=3]="NORMAL",t[t.LOW=4]="LOW"}(e||(e={})),function(t){t.XHR="xhr",t.FETCH="fetch"}(s||(s={})),function(t){t.HTTPERROR="http_error",t.BUSSIONERROR="bussion_error",t.JAVASCRIPT_ERROR="javascript_error",t.RESOURCE_ERROR="resource_error",t.PROMISE_ERROR="promise_error"}(n||(n={}));const o=globalThis,i=(o.__MONITOR__=o.__MONITOR__||{},o.__MONITOR__).silentFlag={},r=(t,e)=>{i[t]||(i[t]=e)},a=(t,e,s)=>{if(!(e in t))return;const n=s(t[e]);"function"==typeof n&&(t[e]=n)},l=()=>Date.now(),c=(t,e,s,n=!1)=>{t.addEventListener(e,s,n)},h=()=>"undefined"==typeof document||null==document.location?"":document.location.href;class u{constructor(){this.stack=[],this.isFlushing=!1,this.micro=Promise.resolve()}addFn(t){"function"==typeof t&&(this.stack.push(t),this.isFlushing||(this.isFlushing=!0,this.micro.then((()=>this.flushStack()))))}flushStack(){const t=this.stack.slice(0);this.stack.length=0,this.isFlushing=!1;for(let e=0;e<t.length;e++)t[e]()}}const p=()=>{if(!("XMLHttpRequest"in o))return;const e=XMLHttpRequest.prototype;a(e,"open",(t=>function(...e){const n=e[1];var o;this.monitor_xhr={method:(o=e[0],"string"==typeof o?e[0].toUpperCase():e[0]),url:e[1],sTime:l(),type:s.XHR},"POST"===this.monitor_xhr.method&&N.isSdkTransportUrl(n)&&(this.monitor_xhr.isSdkUrl=!0),t.apply(this,e)})),a(e,"send",(e=>function(...s){c(this,"loadend",(function(){this.monitor_xhr?.isSdkUrl||(this.monitor_xhr.reqData=s[0],this.monitor_xhr.eTime=l(),this.monitor_xhr.status=this.status,this.monitor_xhr.statusText=this.statusText,this.monitor_xhr.responseText=this.responseText,this.monitor_xhr.elapsedTime=this.monitor_xhr.eTime-this.monitor_xhr.sTime,T(t.XHR,this.monitor_xhr))})),e.apply(this,s)}))};let m;m=h();const R=()=>{const e=e=>function(...s){const n=h(),o=m;m=n,T(t.HISTORY,{to:n,from:o}),e&&e.apply(this,s)};a(o,"popstate",e),a(o.history,"pushState",e),a(o.history,"replaceState",e),c(o,"click",(function(e){const s=e.target;if("A"===s.tagName.toUpperCase()&&s.getAttribute("href")){e.preventDefault();const n=s.getAttribute("href");T(t.HISTORY,{to:n,from:m}),m=n}}),!1)},d={},T=(t,e)=>{t&&d[t]&&d[t].forEach((t=>{try{t(e)}catch(t){console.log("发生错误",t)}}))},H=((t,e,s)=>{let n=s,o=+new Date,i=null;const r=(...s)=>{if(n)t.apply(t,s),n=!1,o=+new Date;else{if(+new Date-o>=e)t.apply(t,s),o=+new Date;else{i&&clearTimeout(i);const n=e-(+new Date-o);i=setTimeout((()=>{t.apply(t,s),o=+new Date}),n)}}};return r.cancel=()=>{i=null,clearTimeout(null),o=0},r})(T,600),O=e=>{switch(e){case t.XHR:p();break;case t.FETCH:"fetch"in o&&a(o,t.FETCH,(e=>function(n,i){const r=l();e.apply(o,[n,i]).then((e=>{console.log(e,"----");const o=l(),a=e.clone(),c={eTime:o,sTime:r,url:n,method:i&&i.method||"GET",type:s.FETCH,status:a.status,statusText:a.statusText,elapsedTime:o-r};a.text().then((e=>{c.responseText=e,T(t.FETCH,c)}))})).catch((e=>{const o=l(),a={eTime:o,sTime:r,url:n,method:i&&i.method||"GET",type:s.FETCH,status:0,statusText:e.name+e.message,elapsedTime:o-r};throw T(t.FETCH,a),e}))}));break;case t.CONSOLE:break;case t.ERROR:c(o,"error",(function(e){T(t.ERROR,e)}),!0);break;case t.HASHCHANGE:o.hasOwnProperty("onpopstate")||c(o,t.HASHCHANGE,(function(e){T(t.HASHCHANGE,e)}),!1);break;case t.HISTORY:R();break;case t.DOM:"document"in o&&c(o.document,"click",(function(e){H(t.DOM,e)}),!1);break;case t.UNHANDLEDREJECTION:c(o,t.UNHANDLEDREJECTION,(function(e){T(t.UNHANDLEDREJECTION,e)}));case t.VUE:}},E=t=>{const{cb:e,type:s}=t;i[s]||(d[s]=d[s]||[],d[s].push(e),O(s))};console.log(d);const f={handleHttp(t,s){if(t.status>=400||0===t.status||s&&t.elapsedTime>=s){const s=function(t){let s=t.responseText;s=0===t.status?t.elapsedTime<=1e3?"接口失败原因为:跨域":"接口失败原因为:超时":"接口上报原因：接口响应慢";return{type:n.HTTPERROR,pageUrl:h(),time:t.eTime,elapsedTime:t.elapsedTime,level:e.HIGH,request:{httpType:t.type,method:t.method,url:t.url,data:t.reqData||""},response:{status:t.status,statusText:t.statusText,description:s}}}(t);N.xhrPost(s)}},handleError(t){const s=t.target;if(s.localName){const t=function(t){return{type:n.RESOURCE_ERROR,pageUrl:h(),message:"资源地址: "+(t.src||t.href),level:e.LOW,time:l(),name:`${g[t.localName]||t.localName} failed to load`}}(s);return N.xhrPost(t)}const{message:o,filename:i,lineno:r,colno:a,error:c}=t;console.log(c);const u=i||h();let p={type:n.JAVASCRIPT_ERROR,message:o,pageUrl:u,level:e.HIGH,time:l(),stack:{line:r,col:a,url:u}};N.xhrPost(p)},handleUnhandlerejection(t){let s={type:n.PROMISE_ERROR,message:JSON.stringify(t.reason),pageUrl:h(),name:t.type,time:l(),level:e.NORMAL};N.xhrPost(s)},handleDom(t){const{path:s}=t,n=(t=>{console.log(t);const e=t[0],{nodeName:s,baseURI:n,attributes:o,outerHTML:i}=e;return{nodeName:s,baseURI:n,attributes:o,outerHTML:i}})(s);console.log(n,"---");let o={message:"埋点",pageUrl:h(),time:l(),level:e.NORMAL,stack:n};N.xhrPost(o)},handleHashchange(t){const{newURL:e,oldURL:s}=t;console.log(e,s)},handleHistory(t){console.log(t)}};const g={img:"图片",script:"脚本"};class y{constructor(t){this.url=t,this.apiKey="",this.beforeSend=null,this.configXhr=null,this.queue=new u}imgPort(t){y.img.src=`${this.url}?${(t=>{if(t)return Object.entries(t).reduce(((t,[e,s],n)=>(0!==n&&(t+="&"),t+`${e}=${s}`)),"")})(t)}`}xhrPost(t){this.queue.addFn((()=>{if("undefined"==typeof XMLHttpRequest)return;if("function"==typeof this.beforeSend&&!(t=this.beforeSend(t)))return;const e=new XMLHttpRequest;e.open("POST",this.url),e.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),"function"==typeof this.configXhr&&this.configXhr(e),e.send(JSON.stringify(this.getTransportData(t))),e.addEventListener("loadend",(function(){console.log(this,111)})),console.log(e)}))}getTransportData(t){return{authInfo:{apikey:this.apiKey},data:t}}isSdkTransportUrl(t){return t.includes(this.url)}bindOptions(t){this.apiKey=t.apikey}}y.img=new Image;const N=new y("http://localhost:3009/api/error/error.gif");return class{constructor(t={}){this.monitorOpts={},this.monitorOpts=t,this.init()}init(){var e;this.monitorOpts.disabled||(this.bindOptions(),e=this.monitorOpts.timeout,E({cb:t=>{f.handleHttp(t,e)},type:t.XHR}),E({cb:t=>{f.handleHttp(t)},type:t.FETCH}),E({cb:t=>{f.handleError(t)},type:t.ERROR}),E({cb:t=>{f.handleDom(t)},type:t.DOM}),E({cb:t=>{f.handleHashchange(t)},type:t.HASHCHANGE}),E({cb:t=>{f.handleHistory(t)},type:t.HISTORY}),E({cb:t=>{f.handleUnhandlerejection(t)},type:t.UNHANDLEDREJECTION}),E({cb:t=>{},type:t.VUE}))}bindOptions(){((e={})=>{r(t.XHR,!!e.silentXhr),r(t.FETCH,!!e.silentFetch),r(t.CONSOLE,!!e.silentConsole),r(t.DOM,!!e.silentDom),r(t.HISTORY,!!e.silentHistory),r(t.ERROR,!!e.silentError),r(t.HASHCHANGE,!!e.silentHashchange),r(t.UNHANDLEDREJECTION,!!e.silentUnhandledrejection),r(t.VUE,!!e.silentVue)})(this.monitorOpts),N.bindOptions(this.monitorOpts)}}}();
//# sourceMappingURL=monitor.me.js.map
